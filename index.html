<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation - Astanarasa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root { --accent-color: #f37021; --bg-dark: #0c0e12; }
        body { background-color: var(--bg-dark); font-family: 'Inter', sans-serif; color: #fff; }
        .main-card { background: #fff; color: #333; border-radius: 16px; max-width: 480px; margin: 30px auto; overflow: hidden; }
        .header-banner { background: #000; padding: 20px; text-align: center; }
        .header-img { width: 100%; height: 140px; object-fit: cover; border-radius: 12px; }
        .content-area { padding: 30px; }
        .hidden { display: none; }
        .btn-primary-custom { background: var(--accent-color); border: none; color: #fff; width: 100%; padding: 15px; border-radius: 8px; font-weight: 700; }
        
        /* Tampilan Tiket */
        #successOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; overflow-y:auto; }
        .ticket-box { background:#fff; width:100%; max-width:350px; border-radius:15px; overflow:hidden; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <div class="header-banner">
            <h2 class="text-white small fw-bold">ASTANARASA RESTAURANT</h2>
            <img src="asset/img/header-landscape.jpg" class="header-img">
        </div>

        <form id="reservationForm" class="content-area">
            <div id="step1">
                <label class="small fw-bold text-muted">TANGGAL</label>
                <input type="date" name="date" id="datePicker" class="form-control mb-3" required>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="small fw-bold text-muted">PAX</label><input type="number" name="pax" id="paxInput" class="form-control" required></div>
                    <div class="col-6"><label class="small fw-bold text-muted">WAKTU</label><select name="time" class="form-select"><option>18:00</option><option>19:00</option></select></div>
                </div>
                <button type="button" class="btn-primary-custom" onclick="goToStep(2)">LANJUT</button>
            </div>

            <div id="step2" class="hidden">
                <input type="text" name="fname" class="form-control mb-2" placeholder="Nama Depan" required>
                <input type="tel" name="phone" class="form-control mb-2" value="+62">
                <textarea name="request" class="form-control mb-3" placeholder="Permintaan Khusus"></textarea>
                <button type="button" class="btn-primary-custom" onclick="goToStep(3)">REVIEW</button>
            </div>

            <div id="step3" class="hidden">
                <div class="text-center mb-3">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=ASTANARASA" class="border p-2">
                    <h5 id="totalText" class="fw-bold mt-2 text-danger"></h5>
                </div>
                <input type="file" id="buktiBayar" class="form-control mb-3" accept="image/*" required>
                <button type="submit" id="submitBtn" class="btn-primary-custom">KIRIM RESERVASI</button>
            </div>
        </form>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxONIi3NjyuX2aqRNs-_Dtgp4T5DoOpOjQd2d3_ByGBCkmXZP3J33aaXMihP1TYicX70g/exec';
    let hargaPerPax = 150000;

    function goToStep(s) {
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.add('hidden');
        document.getElementById('step' + s).classList.remove('hidden');
        if(s===3) {
            const pax = document.getElementById('paxInput').value;
            document.getElementById('totalText').innerText = "Total: Rp " + (pax * hargaPerPax).toLocaleString();
        }
    }

    document.getElementById('reservationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "PROSES GENERATE TIKET...";
        btn.disabled = true;

        const bookingID = "AST-" + Math.random().toString(36).substr(2, 5).toUpperCase();
        const f = new FormData(e.target);

        // 1. Buat Elemen Tiket Tersembunyi untuk difoto
        const ticketHTML = `
            <div id="successOverlay">
                <div id="captureArea" class="ticket-box">
                    <div style="background:#28a745; color:#white; padding:20px; text-align:center;">
                        <h4 style="margin:0; color:white">RESERVASI BERHASIL</h4>
                    </div>
                    <div style="padding:25px; color:#333; background:#fff;">
                        <p style="margin:0; font-size:10px; color:#999;">BOOKING ID</p>
                        <h3 style="color:#f37021; margin-bottom:15px;">${bookingID}</h3>
                        <div style="font-size:13px; border-top:1px dashed #ccc; padding-top:10px;">
                            <p>Nama: <b>${f.get('fname')}</b></p>
                            <p>Tanggal: <b>${f.get('date')}</b></p>
                            <p>Waktu: <b>${f.get('time')} WIB</b></p>
                            <p>Jumlah: <b>${f.get('pax')} Pax</b></p>
                        </div>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <p class="text-white small">Tiket Otomatis Tersimpan di Sistem</p>
                    <button id="downloadBtn" class="btn btn-light btn-sm">Download ke HP</button>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', ticketHTML);

        // 2. Ubah Tiket menjadi Gambar (Base64)
        const canvas = await html2canvas(document.querySelector("#captureArea"));
        const tiketImgData = canvas.toDataURL("image/png").split(',')[1];

        // 3. Baca File Bukti Bayar
        const file = document.getElementById('buktiBayar').files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const finalData = new FormData();
            finalData.append('buktiBase64', evt.target.result.split(',')[1]);
            finalData.append('tiketBase64', tiketImgData); // Kirim gambar tiket juga!
            finalData.append('bookingID', bookingID);
            finalData.append('date', f.get('date'));
            finalData.append('pax', f.get('pax'));
            finalData.append('time', f.get('time'));
            finalData.append('fname', f.get('fname'));
            finalData.append('phone', f.get('phone'));
            finalData.append('request', f.get('request'));
            finalData.append('totalHarga', f.get('pax') * hargaPerPax);
            finalData.append('menuName', "Menu Pilihan");

            fetch(SCRIPT_URL, { method: 'POST', body: finalData })
            .then(() => {
                btn.innerText = "BERHASIL!";
                document.getElementById('downloadBtn').onclick = () => {
                    const link = document.createElement('a');
                    link.download = `Tiket-${bookingID}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                };
            });
        };
        reader.readAsDataURL(file);
    });
</script>
</body>
</html>
