<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation - Astanarasa Restaurant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root { --accent-color: #f37021; --bg-dark: #3b3b3b; --card-white: #ffffff; }
        body { background-color: var(--bg-dark); font-family: 'Inter', sans-serif; color: #fff; margin: 0; padding: 0; }
        .main-card { background: var(--card-white); color: #333; border-radius: 16px; max-width: 480px; margin: 30px auto; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .header-banner { background: #fff; padding: 20px 20px 15px 20px; text-align: center; }
        .header-banner h2 { color: #888; font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; letter-spacing: 2px; }
        .header-img { width: 100%; height: 140px; object-fit: cover; border-radius: 12px; background: #222; margin-bottom: 10px; }
        .stepper-wrapper { display: flex; justify-content: center; padding: 20px 0; background: #fafafa; border-bottom: 1px solid #eee; }
        .step-item { display: flex; flex-direction: column; align-items: center; width: 80px; }
        .step-circle { width: 34px; height: 34px; border-radius: 50%; background: #e0e0e0; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.4s; }
        .step-item.active .step-circle { background: #28a745; transform: scale(1.1); }
        .step-label { font-size: 10px; margin-top: 5px; color: #999; font-weight: 700; text-transform: uppercase; }
        .step-item.active .step-label { color: #28a745; }
        .content-area { padding: 30px; }
        .form-label { font-size: 0.8rem; font-weight: 700; color: #666; text-transform: uppercase; margin-bottom: 6px; }
        .form-control, .form-select { border: 1px solid #ddd; padding: 12px; border-radius: 8px; font-size: 0.95rem; }
        #menuContainer { background: #fffaf5; border: 2px dashed #f37021; border-radius: 12px; padding: 15px; text-align: center; margin-bottom: 20px; cursor: pointer; }
        #menuDisplay { width: 100%; max-width: 180px; border-radius: 8px; margin-top: 10px; }
        .btn-primary-custom { background: var(--accent-color); border: none; color: #fff; width: 100%; padding: 15px; border-radius: 8px; font-weight: 700; transition: 0.3s; }
        .btn-primary-custom:hover { background: #d65d1a; }
        .btn-primary-custom:disabled { background: #ccc; }
        .hidden { display: none; }
        .nav-pills .nav-link { color: #666; font-size: 12px; font-weight: bold; border: 1px solid #ddd; margin: 0 5px; }
        .nav-pills .nav-link.active { background-color: var(--accent-color) !important; border-color: var(--accent-color); }
        #vaNumber { letter-spacing: 1px; color: #333; }
        .quota-badge-center { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.85); color: #fff; padding: 20px 30px; border-radius: 15px; text-align: center; z-index: 10001; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #444; min-width: 200px; }
        .quota-badge-center h6 { font-size: 0.7rem; text-transform: uppercase; margin-bottom: 5px; color: #ccc; }
        .quota-badge-center h2 { font-size: 1.8rem; font-weight: 800; margin: 0; color: #28a745; }
        .summary-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        #successOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; overflow-y:auto; }
        .ticket-card { background:#fff; color:#333; width:100%; max-width:350px; border-radius:0px; overflow:visible !important; position:relative; text-align:center; display:block; height:auto; }
        .modal-portrait { max-width: 320px; margin: auto; }
        #loader { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-light"></div></div>

<div class="container">
    <div class="main-card">
        <div class="header-banner">
            <h2>ASTANARASA RESTO & DINING</h2>
            <img src="asset/img/header-landscape.jpg" class="header-img">
        </div>
        <div class="stepper-wrapper">
            <div class="step-item active" id="stepIcon1"><div class="step-circle">1</div><div class="step-label">Jadwal</div></div>
            <div class="step-item" id="stepIcon2"><div class="step-circle">2</div><div class="step-label">Data</div></div>
            <div class="step-item" id="stepIcon3"><div class="step-circle">3</div><div class="step-label">Review</div></div>
        </div>
        <form id="reservationForm" class="content-area">
            <div id="step1">
                <div class="mb-4">
                    <label class="form-label">Pilih Tanggal Reservasi*</label>
                    <input type="date" name="date" id="datePicker" class="form-control" required min="2026-02-20" max="2026-03-19">
                    <div id="priceInfo" class="small mt-1 text-muted fw-bold"></div>
                </div>
                <div id="menuContainer" class="hidden" onclick="showLightbox()">
                    <span class="badge bg-warning text-dark mb-2">KLIK GAMBAR UNTUK DETAIL</span>
                    <h6 id="menuTitle" class="fw-bold mb-2"></h6>
                    <img id="menuDisplay" src="">
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="form-label">Dewasa</label><input type="number" id="paxDewasa" class="form-control" value="1" min="0"></div>
                    <div class="col-6"><label class="form-label">Anak-anak</label><input type="number" id="paxAnak" class="form-control" value="0" min="0"></div>
                </div>
                <input type="hidden" name="pax" id="paxTotal">
                <button type="button" class="btn-primary-custom" id="btnNext1" onclick="checkQuotaAndTerms()">LANJUT KE DATA DIRI</button>
                <div class="text-center mt-3">
                    <p class="small text-muted">Sudah reservasi? <a href="javascript:void(0)" class="text-primary fw-bold" onclick="showRescheduleModal()">Ubah Jadwal (Reschedule)</a></p>
                </div>
            </div>

            <div id="step2" class="hidden">
                <a href="javascript:void(0)" style="color:#888; text-decoration:none; font-size:0.85rem;" onclick="goToStep(1)">&larr; KEMBALI</a>
                <div class="mb-3 mt-2">
                    <label class="form-label">Panggilan</label>
                    <div class="d-flex gap-2">
                        <input type="radio" class="btn-check" name="title" id="mr" value="Mr." checked><label class="btn btn-outline-secondary btn-sm w-100" for="mr">Mr.</label>
                        <input type="radio" class="btn-check" name="title" id="mrs" value="Mrs."><label class="btn btn-outline-secondary btn-sm w-100" for="mrs">Mrs.</label>
                    </div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="form-label">Nama Depan*</label><input type="text" name="fname" class="form-control" required></div>
                    <div class="col-6"><label class="form-label">Nama Belakang</label><input type="text" name="lname" class="form-control"></div>
                </div>
                <div class="mb-3"><label class="form-label">WhatsApp*</label><input type="tel" name="phone" class="form-control" value="+62" required></div>                
                <div class="mb-4"><label class="form-label">Permintaan Khusus<span style="font-size: 0.7rem; font-weight: 400; color: #aaa; text-transform: none; margin-left: 5px;">(Sesuai ketersediaan)</span></label><textarea name="request" class="form-control" rows="2" placeholder="Contoh : Birthday Surprise..."></textarea></div>
                <button type="button" class="btn-primary-custom" onclick="validateStep2()">KONFIRMASI PESANAN</button>
            </div>

            <div id="step3" class="hidden text-dark">
                <a href="javascript:void(0)" style="color:#888; text-decoration:none; font-size:0.85rem;" onclick="goToStep(2)">&larr; EDIT DATA</a>
                <h5 class="fw-bold mb-3">Review Reservasi</h5>
                <div class="p-3 bg-light rounded-3 mb-3" id="finalSummary"></div>

                <div class="text-center border rounded-3 p-3 mb-3 bg-white">
                    <p class="small fw-bold text-muted mb-3">PILIH METODE PEMBAYARAN</p>
                    <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
                        <li class="nav-item"><button class="nav-link btn-sm" id="tab-qris" data-bs-toggle="pill" data-bs-target="#pay-qris" type="button" disabled style="opacity: 0.5; cursor: not-allowed;">QRIS (Off)</button></li>
                        <li class="nav-item"><button class="nav-link active btn-sm" id="tab-va" data-bs-toggle="pill" data-bs-target="#pay-va" type="button">Transfer VA</button></li>
                    </ul>
                    
                    <div class="tab-content border-top pt-3">
                        <div class="tab-pane fade" id="pay-qris">
                            <img id="qrisImg" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=ASTANARASA" class="mb-2 border p-2 shadow-sm">
                            <div class="mb-2"><button type="button" class="btn btn-sm btn-outline-dark" style="font-size: 10px;" onclick="downloadQR()">ðŸ’¾ Download QRIS</button></div>
                        </div>
                        <div class="tab-pane fade show active" id="pay-va">
                            <div class="p-2 bg-light rounded border mb-2">
                                <p class="mb-1 text-muted" style="font-size: 10px; font-weight: bold;">BANK MANDIRI (VA)</p>
                                <h5 class="fw-bold mb-1" id="vaNumber">889081234567890</h5>
                                <button type="button" class="btn btn-sm btn-dark py-0" style="font-size: 10px;" onclick="copyVA()">ðŸ“‹ Salin No. VA</button>
                            </div>
                            <p style="font-size: 9px; color: #888;">*Pastikan nominal transfer sesuai dengan total bayar</p>
                        </div>
                    </div>
                    <h5 class="fw-bold text-danger mt-3" id="totalBayarText"></h5>
                </div>

                <div class="alert alert-warning mt-3"><p id="textMinimalDP" class="text-danger" style="font-weight:bold;">Minimal Panjar (50%): Rp 0</p>
                </div>
                <div class="form-group"><label>Masukkan Nominal yang Anda Transfer:</label><input type="number" class="form-control" id="nominalTransfer" oninput="calculateInvoice()" placeholder="Contoh: 500000"><small id="msgErrorDP" class="text-danger font-weight-bold"></small>
                </div>

                <div class="mb-4">
                    <label class="form-label text-danger">Upload Bukti Pembayaran*</label>
                    <input type="file" id="buktiBayar" class="form-control" accept="image/*" required onchange="document.getElementById('submitBtn').disabled=false">
                </div>                
                <button type="submit" class="btn-primary-custom" id="submitBtn" disabled>KIRIM RESERVASI</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="termsModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-portrait">
        <div class="modal-content text-dark">
            <div class="modal-header py-2"><h6 class="modal-title fw-bold">Syarat & Ketentuan</h6></div>
            <div class="modal-body py-3" style="font-size: 0.55rem;">
                <p class="mb-1">1. Unggah bukti pembayaran untuk konfirmasi.</p>
                <p class="mb-1">2. Hadir 15 menit sebelum jadwal.</p>
                <p class="mb-1">3. Toleransi keterlambatan 30 menit.</p>
                <p class="mb-1">4. Pemesanan slice cake birthday, konfirmasi langsung dikasir.</p>
                <p class="mb-1">5. Dilarang membawa masuk atau membawa keluar makanan/minuman.</p>
                <p class="mb-1">6. Dilarang membawa banner atau umbul-umbul kegiatan.</p>
                <p class="mb-1">7. Pembatalan kurang dari 24 jam dianggap hangus.</p>
                <p class="mb-1">8. Dilarang melakukan aktivitas yang mengganggu tamu lain.</p>
            </div>
            <div class="modal-footer flex-column py-2">
                <div class="form-check w-100 mb-2">
                    <input class="form-check-input" type="checkbox" id="agreeCheck" onchange="document.getElementById('btnAgree').disabled = !this.checked">
                    <label class="form-check-label" style="font-size:0.7rem;">Saya Setuju</label>
                </div>
                <button type="button" class="btn btn-primary btn-sm w-100" id="btnAgree" disabled onclick="goToStep(2); bootstrap.Modal.getInstance(document.getElementById('termsModal')).hide();">LANJUTKAN</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="rescheduleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered text-dark">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Reschedule Reservasi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resStep1">
                    <label class="form-label">Nomor Reservasi (Booking ID)</label>
                    <input type="text" id="resID" class="form-control mb-3" placeholder="Contoh: 2002-05-ABC">
                    <button type="button" class="btn btn-primary w-100 fw-bold" onclick="findReservation()">CEK DATA</button>
                </div>
                <div id="resStep2" class="hidden">
                    <div id="resInfo" class="alert alert-info py-2 mb-3" style="font-size:0.8rem;"></div>
                    <label class="form-label">Pilih Tanggal Baru*</label>
                    <input type="date" id="newDate" class="form-control mb-3">
                    <div id="repaySection" class="mt-3 p-3 border rounded bg-light hidden">
                        <label class="form-label text-dark">Upload Bukti Pelunasan</label>
                        <input type="file" id="buktiPelunasanFile" class="form-control mb-3" accept="image/*">
                        <button type="button" onclick="processPelunasan()" id="btnPelunasan" class="btn btn-success w-100 fw-bold">
                            âœ… KONFIRMASI PELUNASAN
                        </button>
                    </div>
                    <button type="button" class="btn btn-success w-100 fw-bold" id="btnSaveReschedule" onclick="submitReschedule()">SIMPAN PERUBAHAN</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="imgPreviewModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center p-0"><img id="lightboxImg" src="" class="img-fluid rounded"><div class="p-3"><button type="button" class="btn btn-light" data-bs-dismiss="modal">Tutup</button></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxniTvvkLhnv8_ABVIocDajjxuLQ3ZrgmOUXDXWYH4I5Xv9_KvAIyuElRW6Kr-31X8yqA/exec'; 
    const menuData = { "2026-02-19": "Menu A", "2026-02-20": "Menu B", "2026-02-21": "Menu C", "2026-02-22": "Menu D", "2026-02-23": "Menu E", "2026-02-24": "Menu F", "2026-02-25": "Menu G", "2026-02-26": "Menu H", "2026-02-27": "Menu I", "2026-02-28": "Menu J", "2026-03-01": "Menu A", "2026-03-02": "Menu B", "2026-03-03": "Menu C", "2026-03-04": "Menu D", "2026-03-05": "Menu E", "2026-03-06": "Menu F", "2026-03-07": "Menu G", "2026-03-08": "Menu H", "2026-03-09": "Menu I", "2026-03-10": "Menu J", "2026-03-11": "Menu A", "2026-03-12": "Menu B", "2026-03-13": "Menu C", "2026-03-14": "Menu D", "2026-03-15": "Menu E", "2026-03-16": "Menu F", "2026-03-17": "Menu G", "2026-03-18": "Menu H", "2026-03-19": "Menu I" };
    const menuImages = { "Menu A": "asset/img/menu-a.jpg", "Menu B": "asset/img/menu-b.jpg", "Menu C": "asset/img/menu-c.jpg", "Menu D": "asset/img/menu-d.jpg", "Menu E": "asset/img/menu-e.jpg", "Menu F": "asset/img/menu-f.jpg", "Menu G": "asset/img/menu-g.jpg", "Menu H": "asset/img/menu-h.jpg", "Menu I": "asset/img/menu-i.jpg", "Menu J": "asset/img/menu-j.jpg" };
    const formatIDR = (val) => "Rp " + Number(val).toLocaleString('id-ID');

    let currentDewasaPrice = 150000; 
    const hargaAnak = 80000;
    let tempResData = {}; 

    const resModal = new bootstrap.Modal(document.getElementById('rescheduleModal'));
    function showRescheduleModal() { resModal.show(); }

    async function findReservation() {
        const id = document.getElementById('resID').value;
        if(!id) return alert("Masukkan ID Reservasi!");
        
        document.getElementById('loader').style.display = 'flex';
        try {
            const resp = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "findBooking", bookingID: id }) 
            });

            if (!resp.ok) throw new Error("Server error");

            const data = await resp.json();
            
            if(data.found) {
                window.isReschedule = true;
                dataInvoice.bayar = data.bayar;
                dataInvoice.sisa = data.sisa;
                // FIX: Pastikan data pax tersimpan dengan benar
                tempResData = {
                    name: data.name,
                    paxDetail: data.pax, // Mengambil data pax dari kolom sheet
                    oldDateRaw: data.oldDateRaw
                };

                // Logika menampilkan fitur pelunasan
                const repayBox = document.getElementById('repaySection');
                if (data.sisa && data.sisa !== "Lunas" && data.sisa > 0) {
                    repayBox.classList.remove('hidden');
                } else {
                    repayBox.classList.add('hidden');
                }
                
                const oldDateObj = new Date(data.oldDateRaw);
                const isPromo = (oldDateObj >= new Date("2026-02-20") && oldDateObj <= new Date("2026-03-02"));
                
                const dateInput = document.getElementById('newDate');
                if(isPromo) {
                    dateInput.min = "2026-02-20";
                    dateInput.max = "2026-03-02";
                    document.getElementById('resInfo').innerHTML = `Halo <b>${data.name}</b>, Paket Anda: <b>Promo</b>. Pilih tanggal baru (20 Feb - 02 Mar).`;
                } else {
                    dateInput.min = "2026-03-03";
                    dateInput.max = "2026-03-19";
                    document.getElementById('resInfo').innerHTML = `Halo <b>${data.name}</b>, Paket Anda: <b>Normal</b>. Pilih tanggal baru (03 Mar - 19 Mar).`;
                }
                document.getElementById('resStep1').classList.add('hidden');
                document.getElementById('resStep2').classList.remove('hidden');
            } else { alert("Data tidak ditemukan."); }
        } catch (e) { alert("Error koneksi."); }
        document.getElementById('loader').style.display = 'none';
    }

    async function submitReschedule() {
        const id = document.getElementById('resID').value;
        const newD = document.getElementById('newDate').value;
        if(!newD) return alert("Pilih tanggal!");
    
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('btnSaveReschedule').disabled = true;
        
        try {
            // 1. Update Database & Ambil Status
            const response = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "updateDate", bookingID: id, newDate: newD }) 
            });
            const result = await response.text();
        
            if(result === "LIMIT_REACHED") {
                alert("Maaf, Reschedule hanya diperbolehkan maksimal 1 kali.");
                document.getElementById('loader').style.display = 'none';
                document.getElementById('btnSaveReschedule').disabled = false;
            } else if(result.startsWith("SUCCESS")) {
                resModal.hide();
                // 2. Generate Tiket & Kirim ke Drive
                await generateSuccessTicket(id, newD, tempResData.name, tempResData.paxDetail, true);
            }
        } catch (e) { 
            alert("Gagal update database."); 
            document.getElementById('loader').style.display = 'none';
            document.getElementById('btnSaveReschedule').disabled = false;
        }
    }

    async function generateSuccessTicket(bookingID, dateVal, fullName, paxDetail, isReschedule = false) {
        const cantik = getTanggalCantik(dateVal);
        const fixedTime = "17:45 - 20:00";
        const isLunas = (dataInvoice.sisa === 0 || dataInvoice.sisa === "Lunas");
        
        let labelStatus = isReschedule ? "TIKET RESCHEDULE" : "RESERVASI BERHASIL!";
        let labelColor = isReschedule ? "#007bff" : "#28a745";
        
        if (isLunas) {
            labelStatus = "TIKET LUNAS / PAID";
            labelColor = "#198754"; // Hijau Tua khas Lunas
        }

        const successHTML = `
            <div id="successOverlay">
                <div id="captureArea" class="ticket-card" style="max-width: 380px; border: none; background: #fff; border-radius:0px; text-align:center;">

                    ${isLunas ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); font-size: 80px; color: rgba(25, 135, 84, 0.2); font-weight: 900; z-index: 0; pointer-events: none;">PAID</div>` : ''}
                    
                    <div style="background:${labelColor}; color:#fff; padding:20px;"><h4 style="margin:0; font-weight:800;">${labelStatus}</h4></div>
                    <div style="padding:25px; background:#fff; color:#333;">
                        <p style="margin:0; color:#888; font-size:11px; font-weight:bold;">NOMOR RESERVASI</p>
                        <h2 style="color:#f37021; font-weight:800; letter-spacing:2px; margin:5px 0;">${bookingID}</h2>
                        <div style="margin: 10px auto; width: 150px; height: 150px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; background: #fff; overflow: hidden;">
                            <img src="https://quickchart.io/qr?text=${bookingID}&size=300" crossorigin="anonymous" style="width: 100%; height: 100%; object-fit: contain; padding: 5px;">
                        </div>                                                
                        <hr style="border-top:2px dashed #eee; margin: 15px 0;">
                        <div style="text-align:left; font-size:13px; line-height:2; margin-bottom: 20px;">
                            <div style="display:flex; justify-content:space-between;"><span>Nama:</span><b>${fullName}</b></div>
                            <div style="display:flex; justify-content:space-between;"><span>Tanggal:</span><b>${cantik}</b></div>
                            <div style="display:flex; justify-content:space-between;"><span>Waktu:</span><b>${fixedTime} WIB</b></div>
                            <div style="display:flex; justify-content:space-between;"><span>Jumlah:</span><b>${paxDetail}</b></div>

                        <div style="display:flex; justify-content:space-between; border-top: 1px dashed #eee; margin-top: 5px; padding-top: 5px;">
                            <span>${isLunas ? 'Total Bayar:' : 'Panjar:'}</span>
                            <b style="color: #28a745;">Rp ${Number(dataInvoice.bayar).toLocaleString('id-ID')}</b>
                        </div>

                        ${!isLunas ? `
                        <div style="display:flex; justify-content:space-between;">
                            <span>Sisa Bayar:</span><b style="color: #f37021;">Rp ${Number(dataInvoice.sisa).toLocaleString('id-ID')}</b>
                        </div>` : `
                        <div style="display:flex; justify-content:space-between;">
                            <span>Status:</span><b style="color: #198754;">LUNAS</b>
                        </div>`}
                        </div>

                        <div style="background:#f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 12px; text-align: left;">
                            <p style="margin:0 0 5px 0; font-size:9px; font-weight:bold; color:#555; text-transform:uppercase;">Syarat & Ketentuan (Disetujui):</p>                            
                            <ul style="margin:0; padding-left:15px; font-size:8px; color:#777; line-height:1.4;">
                                <li>Unggah bukti pembayaran untuk konfirmasi.</li>
                                <li>Hadir 15 menit sebelum jadwal.</li>
                                <li>Toleransi keterlambatan 30 menit.</li>
                                <li>Pemesanan slice cake birthday, konfirmasi langsung dikasir.</li>
                                <li>Dilarang membawa masuk atau membawa keluar makanan/minuman.</li>
                                <li>Dilarang membawa banner atau umbul-umbul kegiatan.</li>
                                <li>Pembatalan kurang dari 24 jam dianggap hangus.</li>
                                <li>Dilarang melakukan aktivitas yang mengganggu tamu lain.</li>
                            </ul>
                            <div style="margin-top:8px; border-top:1px solid #eee; padding-top:5px; text-align:right;"><span style="font-size:8px; color:${labelColor}; font-weight:bold;">&#10003; CUSTOMER TELAH MENYETUJUI</span></div>                            
                        </div>
                    </div>
                </div>
                <div class="mt-4"><button id="dlAction" class="btn btn-light fw-bold">ðŸ’¾ DOWNLOAD TIKET (PNG)</button></div>
            </div>`;
        
        document.body.insertAdjacentHTML('beforeend', successHTML);

        // Render Canvas & Upload ke Drive
        setTimeout(async () => {
            const canvas = await html2canvas(document.querySelector("#captureArea"), { scale: 2, useCORS: true });
            const tiketBase64 = canvas.toDataURL("image/png").split(',')[1];

            // Jika Reschedule, kirim tiket ke Drive untuk update link
            if(isReschedule) {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: "uploadRescheduleTicket", 
                        bookingID: bookingID, 
                        tiketBase64: tiketBase64 
                    })
                });
            }

            document.getElementById('dlAction').onclick = async function() {
                const btn = this;
                const isLunas = (dataInvoice.sisa === 0 || dataInvoice.sisa === "Lunas");
                const isRescheduleMode = window.isReschedule; // Cek status mode

                btn.disabled = true;
                btn.innerText = "MENYIMPAN...";

                // 1. Ambil gambar dari Canvas
                const tiketBase64 = canvas.toDataURL("image/png");

                // 2. Kirim ke GS dengan info status (isReschedule)
                const payload = {
                    action: "updateTicketDrive",
                    bookingID: bookingID,
                    tiketBase64: tiketBase64,
                    isReschedule: isRescheduleMode, // Kirim info ke GS
                    isLunas: Number(dataInvoice.sisa) <= 0
                };

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });

                    const result = await response.text();

                    if (result.includes("SUCCESS")) {
                        const downloadUrl = result.split("|")[1];

                        // 3. LOGIKA DOWNLOAD LOKAL (Penamaan File)
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL("image/png");    
                        
                        
                        // Jika Reschedule pakai nama Rescheduled, jika tidak pakai nama Tiket saja
                        if (isLunas) {          
                            link.download = `Tiket-${bookingID}-Paid.png`;
                        } else if (isRescheduleMode) {
                            link.download = `Tiket-${bookingID}-Rescheduled.png`;
                        } else {
                            link.download = `Tiket-${bookingID}.png`;
                        }

                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        btn.innerText = "REFRESH DALAM 3 DETIK...";
                        setTimeout(() => window.location.replace(window.location.href), 3000);
                    } else {
                        alert("Gagal: " + result);
                        btn.disabled = false;
                    }
                } catch (err) {
                    alert("Koneksi Error");
                    btn.disabled = false;
                }
            };
            document.getElementById('loader').style.display = 'none';
        }, 1000);
    }

    
    // Global Variable untuk menyimpan data invoice
    let dataInvoice = { total: 0, bayar: 0, sisa: 0, status: "" };

    function calculateInvoice() {
        const tanggalInput = document.getElementById('datePicker').value;
        const paxDewasa = parseInt(document.getElementById('paxDewasa').value) || 0;
        const paxAnak = parseInt(document.getElementById('paxAnak').value) || 0;
        const nominalTransfer = parseInt(document.getElementById('nominalTransfer').value) || 0;

        const totalPax = paxDewasa + paxAnak;
        if(document.getElementById('paxTotal')) {
            document.getElementById('paxTotal').value = totalPax;
        }
        
        if (!tanggalInput) return;

        // Logika Harga Berdasarkan Tanggal
        let hargaDewasa = 0;
        const selectedDate = new Date(tanggalInput);
        const start1 = new Date('2026-02-20');
        const end1 = new Date('2026-03-02');
        const start2 = new Date('2026-03-03');
        const end2 = new Date('2026-03-19');

        if (selectedDate >= start1 && selectedDate <= end1) {
            hargaDewasa = 100000;
        } else if (selectedDate >= start2 && selectedDate <= end2) {
            hargaDewasa = 150000;
        } else {
            hargaDewasa = 100000; // Default
        }

        const totalHarga = (paxDewasa * hargaDewasa) + (paxAnak * 80000);
        const minDP = totalHarga * 0.5;

        const sisaHitung = totalHarga - nominalTransfer;
        dataInvoice.sisa = sisaHitung < 0 ? 0 : sisaHitung;

        // Update UI
        //document.getElementById('textTotalHarga').innerText = "Total Tagihan: Rp " + totalHarga.toLocaleString();
        document.getElementById('textMinimalDP').innerText = "Minimal Panjar (50%): Rp " + minDP.toLocaleString();

        // Validasi Submit
        const btnSubmit = document.getElementById('submitBtn'); // Pastikan ID tombol submit Anda benar
        if (nominalTransfer < minDP) {
            document.getElementById('msgErrorDP').innerText = "âš ï¸ Nominal kurang dari 50%!";
            btnSubmit.disabled = true;
        } else {
            document.getElementById('msgErrorDP').innerText = "";
            btnSubmit.disabled = false;
        }

        // Update Global Data
        dataInvoice = {
            total: totalHarga,
            bayar: nominalTransfer,
            sisa: totalHarga - nominalTransfer
        };
    }
    
    document.getElementById('paxDewasa').addEventListener('input', calculateInvoice);
    document.getElementById('paxAnak').addEventListener('input', calculateInvoice);
    document.getElementById('datePicker').addEventListener('change', calculateInvoice);
    document.getElementById('nominalTransfer').addEventListener('input', calculateInvoice);

    document.getElementById('datePicker').addEventListener('change', async function() {
        const val = this.value;
        if(!val) return;
        window.currentTanggalCantik = getTanggalCantik(val);
        const selDate = new Date(val);
        const startDate = new Date("2026-02-20");
        const endDate = new Date("2026-03-02");
        currentDewasaPrice = (selDate >= startDate && selDate <= endDate) ? 100000 : 150000;
        document.getElementById('priceInfo').innerText = `Dewasa: Rp ${currentDewasaPrice.toLocaleString('id-ID')} | Anak: Rp 80.000`;
        calculateInvoice();
        if(menuData[val]) {
            document.getElementById('menuTitle').innerText = menuData[val];
            document.getElementById('menuDisplay').src = menuImages[menuData[val]];
            document.getElementById('menuContainer').classList.remove('hidden');
        }
        let qBox = document.getElementById('qBox') || createQuotaBox();
        document.getElementById('qCount').innerText = "Memeriksa...";
        qBox.style.display = 'block';
        try {
            const resp = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "checkQuota", date: val }) });
            const result = await resp.json();
            const remaining = 500 - (result.used || 0);
            if (remaining <= 0) {
                document.getElementById('qCount').innerText = "FULL BOOK";
                document.getElementById('qCount').style.color = "#ff4444";
                document.getElementById('btnNext1').disabled = true;
            } else {
                document.getElementById('qCount').innerText = "Pax Tersedia";
                document.getElementById('qCount').style.color = "#28a745";
                document.getElementById('btnNext1').disabled = false;
            }
        } catch (e) { document.getElementById('qCount').innerText = "Koneksi Bermasalah"; }
    });

    function createQuotaBox() {
        document.body.insertAdjacentHTML('beforeend', '<div id="qBox" class="quota-badge-center" onclick="this.style.display=\'none\'"><h6>Status Ketersediaan</h6><h2 id="qCount"></h2><div id="qHint" style="font-size:9px; margin-top:10px; color:#aaa;">(Klik untuk menutup)</div></div>');
        return document.getElementById('qBox');
    }

    function getTanggalCantik(dateStr) {
        if(!dateStr) return "-";
        const d = new Date(dateStr);
        const bulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        return d.getDate() + " " + bulan[d.getMonth()] + " " + d.getFullYear();
    }

    function checkQuotaAndTerms() {
        // 1. Ambil tanggal dari ID yang benar
        const date = document.getElementById('datePicker').value;
    
        // 2. Ambil & jumlahkan pax dewasa + anak
        const dewasa = parseInt(document.getElementById('paxDewasa').value) || 0;
        const anak = parseInt(document.getElementById('paxAnak').value) || 0;
        const totalPax = dewasa + anak;

        // 3. Validasi
        if(!date) {
            return alert("Mohon pilih Tanggal!");
        }
        if(totalPax <= 0) {
            return alert("Mohon masukkan Jumlah Orang!");
        }

        // Jika ok, simpan detail pax ke window agar bisa dipakai di tiket nanti
        window.currentPaxDetail = `${dewasa} Dewasa, ${anak} Anak`;
    
        // Tampilkan Modal Syarat & Ketentuan
        new bootstrap.Modal(document.getElementById('termsModal')).show();
    }

    function copyVA() {
        const vaNum = document.getElementById('vaNumber').innerText;
        navigator.clipboard.writeText(vaNum).then(() => alert("Nomor VA disalin!"));
    }

    function downloadQR() {
        const link = document.createElement('a');
        link.href = document.getElementById('qrisImg').src;
        link.download = 'QRIS-Astanarasa.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showLightbox() { document.getElementById('lightboxImg').src = document.getElementById('menuDisplay').src; new bootstrap.Modal(document.getElementById('imgPreviewModal')).show(); }

    function goToStep(step) {
        document.querySelectorAll('[id^="step"]').forEach(el => { if(el.id.length <= 5) el.classList.add('hidden'); });
        document.getElementById('step' + step).classList.remove('hidden');
        document.querySelectorAll('.step-item').forEach((it, idx) => { if(idx < step) it.classList.add('active'); else it.classList.remove('active'); });
    }

    function validateStep2() {
        // 1. Tutup modal terms jika masih terbuka
        const modalEl = document.getElementById('termsModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        // 2. Ambil data dari form
        const f = new FormData(document.getElementById('reservationForm'));

        // 3. Pastikan Tanggal Cantik sudah terisi
        // Jika karena suatu hal kosong, kita ambil ulang dari datePicker
        if (!window.currentTanggalCantik) {
            const dateVal = document.getElementById('datePicker').value;
            window.currentTanggalCantik = getTanggalCantik(dateVal);
        }    
    
        // 4. Update Ringkasan di Step 3 dengan data invoice dan pax yang sudah dihitung
        if(document.getElementById('totalBayarText')) {
            document.getElementById('totalBayarText').innerText = "TOTAL: Rp " + dataInvoice.total.toLocaleString('id-ID');
        }

        const summaryEl = document.getElementById('finalSummary');
        if(summaryEl) {
            summaryEl.innerHTML = `
                <div class="summary-item"><span>Nama</span><b>${f.get('title') || ''} ${f.get('fname') || ''} ${f.get('lname') || ''}</b></div>
                <div class="summary-item"><span>Waktu</span><b>${window.currentTanggalCantik || '-'} / 17:45 - 20:00 WIB</b></div>
                <div class="summary-item"><span>Rincian</span><b>${window.currentPaxDetail || '-'}</b></div>
            `;
        }
    
        // 5. Pindah ke Step 3 (Review & Pembayaran)
        goToStep(3);
    }

    document.getElementById('reservationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        window.isReschedule = false;
        const btn = document.getElementById('submitBtn'); btn.innerText = "MENGIRIM..."; btn.disabled = true;
        const dateVal = document.getElementById('datePicker').value;
        const d = new Date(dateVal);
        const randomChars = Array.from({length: 3}, () => String.fromCharCode(65 + Math.floor(Math.random() * 26))).join('');
        const totalPax = document.getElementById('paxTotal').value;
        const bookingID = `${("0"+d.getDate()).slice(-2)}${("0"+(d.getMonth()+1)).slice(-2)}-${totalPax.padStart(2,'0')}-${randomChars}`;
        const f = new FormData(e.target);

        await generateSuccessTicket(bookingID, dateVal, `${f.get('title')} ${f.get('fname')} ${f.get('lname')}`, window.currentPaxDetail, false);

        try {
            const canvas = await html2canvas(document.querySelector("#captureArea"), { scale: 2, useCORS: true });
            const tiketBase64 = canvas.toDataURL("image/png").split(',')[1];
            const file = document.getElementById('buktiBayar').files[0];
            const reader = new FileReader();
            reader.onload = async function(evt) {
                const payload = {
                    buktiBase64: evt.target.result.split(',')[1],
                    tiketBase64: tiketBase64,
                    bookingID: bookingID,
                    date: f.get('date'),
                    pax: window.currentPaxDetail, 
                    totalHarga: dataInvoice.total,
                    bayar: dataInvoice.bayar,  
                    sisa: dataInvoice.sisa,
                    title: f.get('title'), 
                    fname: f.get('fname'), 
                    lname: f.get('lname') || "", 
                    phone: f.get('phone'),
                    request: f.get('request') || "", 
                    menuName: menuData[dateVal], 
                    action: "newBooking"
                };
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            };
            reader.readAsDataURL(file);
        } catch (err) { console.error(err); }
    });

    async function processPelunasan() {
        const fileInput = document.getElementById('buktiPelunasanFile');        
        const id = document.getElementById('resID').value;

        if (fileInput.files.length === 0) return alert("Silakan unggah bukti transfer pelunasan!");
        if (fileInput.files[0].size > 2 * 1024 * 1024) { // Batas 2MB
            return alert("Ukuran file terlalu besar! Maksimal 2MB agar proses cepat.");
        }
        if (!confirm("Konfirmasi pelunasan untuk ID: " + id + "?")) return;

        const btn = document.getElementById('btnPelunasan');
        btn.disabled = true;
        btn.innerText = "SEDANG MEMPROSES...";
        document.getElementById('loader').style.display = 'flex';

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function(e) {
            const base64 = e.target.result.split(',')[1];
            const payload = {
                action: "settlePayment",
                bookingID: id,
                buktiBase64: base64
            };

            try {
                const resp = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await resp.text();
            
                if (result.includes("SUCCESS")) {
                    // 1. Update data invoice di browser agar 'Sisa' jadi 0
                    dataInvoice.bayar = Number(dataInvoice.bayar) + Number(dataInvoice.sisa);
                    dataInvoice.sisa = 0;

                    // 2. Beri notifikasi
                    alert("Pembayaran Lunas Berhasil Diverifikasi!");

                    // 3. Pemicu Tiket Lunas
                    // Menggunakan data yang disimpan saat pencarian di awal
                    generateSuccessTicket(
                        document.getElementById('resID').value, // ID Booking
                        tempResData.oldDateRaw,                 // Tanggal
                        tempResData.name,                        // Nama
                        tempResData.paxDetail,                   // Detail Pax
                        false                                    // isReschedule = false
                    );

                } else {
                    alert("Gagal: " + result);
                }
            } catch (err) {
                alert("Terjadi kesalahan koneksi.");
            } finally {
                btn.disabled = false;
                btn.innerText = "âœ… KONFIRMASI PELUNASAN";
                document.getElementById('loader').style.display = 'none';
            }
        };
        reader.readAsDataURL(file);
    }
</script>
</body>
</html>
